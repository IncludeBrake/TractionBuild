services:
  neo4j:
    image: neo4j:5
    container_name: tractionbuild-neo4j
    environment:
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD}
    ports: ["7474:7474", "7687:7687"]
    volumes: [neo4j_data:/data]
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --spider http://localhost:7474 || exit 1"]
      interval: 10s

  redis:
    image: "redis:alpine"
    container_name: tractionbuild-redis
    ports: ["6379:6379"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s

  api:
    build: .
    container_name: tractionbuild-api
    command: uvicorn tractionbuild.api.app:app --app-dir src --host 0.0.0.0 --port 8000 --reload
    ports: ["8000:8000"]
    env_file: .env

  worker:
    build: .
    container_name: tractionbuild-worker
    command: celery -A src.tractionbuild.tasks.celery_app worker --loglevel=info
    env_file: .env
    depends_on:
      neo4j: { condition: service_healthy }
      redis: { condition: service_healthy }

  frontend:
    build: .
    container_name: tractionbuild-frontend
    command: streamlit run chat_ui.py --server.port 8501 --server.address 0.0.0.0
    ports: ["8501:8501"]
    env_file: .env
    depends_on:
      api: { condition: service_started }

volumes:
  neo4j_data: