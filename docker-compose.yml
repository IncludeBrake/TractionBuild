# Using YAML anchors for a DRY (Don't Repeat Yourself) configuration
x-app-base: &app-base
  build: .
  env_file: .env
  volumes:
    - ./src:/app/src
    - ./config:/app/config
    - ./runs:/app/runs
    - ./output:/app/output
    - ./:/app  # Mount root to find chat_ui.py
  depends_on:
    neo4j:
      condition: service_healthy
    redis:
      condition: service_healthy

services:
  # The Neo4j Database
  neo4j:
    image: neo4j:5
    container_name: zerotoship-neo4j
    environment:
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD}
    ports: ["7474:7474", "7687:7687"]
    volumes: [neo4j_data:/data]
    healthcheck:
      test: ["CMD-SHELL", "wget --quiet --spider http://localhost:7474 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # The Redis Message Broker
  redis:
    image: "redis:alpine"
    container_name: zerotoship-redis
    ports: ["6379:6379"]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # The FastAPI Service
  api:
    <<: *app-base
    container_name: zerotoship-api
    command: uvicorn src.zerotoship.api.app:app --host 0.0.0.0 --port 8000 --reload
    ports: ["8000:8000"]

  # The Celery Worker Service
  worker:
    <<: *app-base
    container_name: zerotoship-worker
    command: celery -A src.zerotoship.tasks.celery_app worker --loglevel=info

  # The Streamlit Frontend Service
  frontend:
    <<: *app-base
    container_name: zerotoship-frontend
    command: streamlit run chat_ui.py --server.port 8501 --server.address 0.0.0.0
    ports: ["8501:8501"]

volumes:
  neo4j_data: